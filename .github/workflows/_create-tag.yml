# -----------------------------------------------
# _create-tag - タグ作成ワークフロー
#
# 前提:
#   - Secret: PIPELINE_GITHUB_TOKEN (repository_dispatch用)
#   - Secret: GOOGLE_CHAT_WEBHOOK_URL (通知用)
#
# 使い方:
#   repository_dispatch 経由でチェーンから呼び出される
#   workflow_dispatch で単体テストも可能
# -----------------------------------------------
name: タグ作成

on:
  repository_dispatch:
    types: [create-tag]
  workflow_dispatch:
    inputs:
      tag_name:
        description: '作成するタグ名 (空の場合は自動生成)'
        required: false
        type: string
        default: ''
      branch:
        description: 'タグを作成するブランチ'
        required: false
        type: string
        default: 'main'

permissions:
  contents: write

concurrency:
  group: deploy-pipeline
  cancel-in-progress: false

jobs:
  create-tag:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: パラメータを決定
        id: params
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          CP_TAG: ${{ github.event.client_payload.tag }}
          CP_BRANCH: ${{ github.event.client_payload.branch }}
          INPUT_TAG: ${{ inputs.tag_name }}
          INPUT_BRANCH: ${{ inputs.branch }}
        run: |
          if [ "${EVENT_NAME}" = "repository_dispatch" ]; then
            TAG="${CP_TAG}"
            BRANCH="${CP_BRANCH}"
            CONTEXT='${{ toJSON(github.event.client_payload) }}'
          else
            TAG="${INPUT_TAG}"
            BRANCH="${INPUT_BRANCH}"
            if [ -z "${TAG}" ]; then
              TAG="release-$(date -u +%Y%m%d-%H%M%S)-${GITHUB_RUN_NUMBER}"
            fi
            CONTEXT=$(jq -n \
              --arg tag "${TAG}" \
              --arg branch "${BRANCH}" \
              --arg pipeline_id "run-${GITHUB_RUN_ID}" \
              --arg repository "${GITHUB_REPOSITORY}" \
              '{tag: $tag, branch: $branch, deploy_dir: "", pipeline_id: $pipeline_id, repository: $repository}')
          fi

          BRANCH="${BRANCH:-main}"

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "context=${CONTEXT}" >> "$GITHUB_OUTPUT"

      - name: タグを作成
        id: create-tag
        continue-on-error: true
        uses: ./.github/actions/create-tag
        with:
          tag_name: ${{ steps.params.outputs.tag }}
          branch: ${{ steps.params.outputs.branch }}

      - name: 結果を通知 → 次ステップへ
        if: always()
        uses: ./.github/actions/notify-chat
        with:
          webhook_url: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
          status: ${{ steps.create-tag.outcome == 'success' && 'success' || 'failure' }}
          title: ${{ steps.create-tag.outcome == 'success' && 'タグ作成完了' || 'タグ作成失敗' }}
          message: >-
            ${{ steps.create-tag.outcome == 'success'
              && format('タグ {0} を作成しました (commit: {1})', steps.params.outputs.tag, steps.create-tag.outputs.commit_sha)
              || format('タグ {0} の作成に失敗しました。ログを確認してください', steps.params.outputs.tag) }}
          next_event: deploy-checkout
          payload: ${{ steps.params.outputs.context }}
          github_token: ${{ secrets.PIPELINE_GITHUB_TOKEN }}
