# -----------------------------------------------
# _clear-cdn-cache - CDNキャッシュ削除ワークフロー
#
# GitHub Environments を使ってサイトごとにCDN設定を管理する。
# 手動実行時はドロップダウンからサイト(Environment)を選択する。
#
# 前提:
#   各 Environment に以下を設定:
#     Variable: CDN_PROVIDER (cloudflare / aws)
#     Cloudflare: Secret: CLOUDFLARE_ZONE_ID, CLOUDFLARE_API_TOKEN
#     AWS:        Secret: CLOUDFRONT_DISTRIBUTION_ID, AWS_ACCESS_KEY_ID,
#                         AWS_SECRET_ACCESS_KEY, AWS_REGION (任意)
#   共通 (リポジトリレベル):
#     Secret: PIPELINE_GITHUB_TOKEN, GOOGLE_CHAT_WEBHOOK_URL
#
# 使い方:
#   repository_dispatch 経由でチェーンから呼び出される
#   workflow_dispatch で単体テストも可能 (サイトを選択)
# -----------------------------------------------
name: CDNキャッシュ削除

on:
  repository_dispatch:
    types: [clear-cdn-cache]
  workflow_dispatch:
    inputs:
      site:
        description: 'サイト (Environment名)'
        required: true
        type: environment
      invalidation_paths:
        description: 'キャッシュ無効化するパス (AWS CloudFront用、デフォルト: /*)'
        required: false
        type: string
        default: '/*'

permissions:
  contents: read

concurrency:
  group: deploy-pipeline
  cancel-in-progress: false

jobs:
  clear-cache:
    runs-on: ubuntu-latest
    environment: ${{ inputs.site || github.event.client_payload.cdn_environment }}
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: パラメータを決定
        id: params
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          CP_TAG: ${{ github.event.client_payload.tag }}
          CP_INVALIDATION_PATHS: ${{ github.event.client_payload.invalidation_paths }}
          INPUT_INVALIDATION_PATHS: ${{ inputs.invalidation_paths }}
          CDN_PROVIDER: ${{ vars.CDN_PROVIDER }}
        run: |
          PROVIDER="${CDN_PROVIDER:-cloudflare}"

          if [ "${EVENT_NAME}" = "repository_dispatch" ]; then
            CONTEXT='${{ toJSON(github.event.client_payload) }}'
            TAG="${CP_TAG}"
            PATHS="${CP_INVALIDATION_PATHS:-/*}"
          else
            CONTEXT='{}'
            TAG='(手動実行)'
            PATHS="${INPUT_INVALIDATION_PATHS:-/*}"
          fi
          echo "context=${CONTEXT}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "provider=${PROVIDER}" >> "$GITHUB_OUTPUT"
          echo "invalidation_paths=${PATHS}" >> "$GITHUB_OUTPUT"

      - name: CDNキャッシュを削除
        id: clear-cache
        continue-on-error: true
        uses: ./.github/actions/clear-cdn-cache
        with:
          provider: ${{ steps.params.outputs.provider }}
          # Cloudflare
          cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # AWS CloudFront
          aws_distribution_id: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_region: ${{ secrets.AWS_REGION }}
          invalidation_paths: ${{ steps.params.outputs.invalidation_paths }}

      - name: 結果を通知 (パイプライン完了)
        if: always()
        uses: ./.github/actions/notify-chat
        with:
          webhook_url: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
          status: ${{ steps.clear-cache.outcome == 'success' && 'success' || 'failure' }}
          title: ${{ steps.clear-cache.outcome == 'success' && 'パイプライン完了' || 'CDNキャッシュ削除失敗' }}
          message: >-
            ${{ steps.clear-cache.outcome == 'success'
              && format('CDNキャッシュを削除しました ({0})。デプロイパイプライン完了 (タグ: {1})', steps.params.outputs.provider, steps.params.outputs.tag)
              || format('CDNキャッシュの削除に失敗しました ({0}, タグ: {1})。手動でキャッシュをパージしてください', steps.params.outputs.provider, steps.params.outputs.tag) }}
          github_token: ${{ secrets.PIPELINE_GITHUB_TOKEN }}
