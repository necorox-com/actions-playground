# -----------------------------------------------
# _notify-chat - Google Chat通知ワークフロー
#
# 前提:
#   - Secret: GOOGLE_CHAT_WEBHOOK_URL
#   - Secret: PIPELINE_GITHUB_TOKEN (次アクション連鎖時)
#
# 使い方:
#   repository_dispatch 経由でチェーンから呼び出される
#   workflow_dispatch で単体テストも可能
# -----------------------------------------------
name: Chat通知

on:
  repository_dispatch:
    types: [notify-chat]
  workflow_dispatch:
    inputs:
      status:
        description: '通知ステータス'
        required: true
        type: choice
        options:
          - success
          - failure
          - info
        default: info
      title:
        description: 'カードタイトル'
        required: true
        type: string
      message:
        description: 'メッセージ本文'
        required: true
        type: string
      next_event:
        description: '次にトリガーするevent_type (空ならパイプライン終了)'
        required: false
        type: string
        default: ''
      payload:
        description: '次のワークフローに渡すJSON payload'
        required: false
        type: string
        default: '{}'

permissions:
  contents: read

concurrency:
  group: deploy-pipeline
  cancel-in-progress: false

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: パラメータを決定
        id: params
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          CP_STATUS: ${{ github.event.client_payload.status }}
          CP_TITLE: ${{ github.event.client_payload.title }}
          CP_MESSAGE: ${{ github.event.client_payload.message }}
          CP_NEXT_EVENT: ${{ github.event.client_payload.next_event }}
          CP_FULL: ${{ toJSON(github.event.client_payload.pipeline_context) }}
          INPUT_STATUS: ${{ inputs.status }}
          INPUT_TITLE: ${{ inputs.title }}
          INPUT_MESSAGE: ${{ inputs.message }}
          INPUT_NEXT_EVENT: ${{ inputs.next_event }}
          INPUT_PAYLOAD: ${{ inputs.payload }}
        run: |
          if [ "${EVENT_NAME}" = "repository_dispatch" ]; then
            echo "status=${CP_STATUS:-info}" >> "$GITHUB_OUTPUT"
            echo "title=${CP_TITLE:-Pipeline Notification}" >> "$GITHUB_OUTPUT"
            echo "message=${CP_MESSAGE}" >> "$GITHUB_OUTPUT"
            echo "next_event=${CP_NEXT_EVENT}" >> "$GITHUB_OUTPUT"

            # pipeline_context がある場合はそれを使い、なければ client_payload 全体を使う
            if [ "${CP_FULL}" = "null" ] || [ -z "${CP_FULL}" ]; then
              PAYLOAD='${{ toJSON(github.event.client_payload) }}'
            else
              PAYLOAD="${CP_FULL}"
            fi
            echo "payload=${PAYLOAD}" >> "$GITHUB_OUTPUT"
          else
            echo "status=${INPUT_STATUS}" >> "$GITHUB_OUTPUT"
            echo "title=${INPUT_TITLE}" >> "$GITHUB_OUTPUT"
            echo "message=${INPUT_MESSAGE}" >> "$GITHUB_OUTPUT"
            echo "next_event=${INPUT_NEXT_EVENT}" >> "$GITHUB_OUTPUT"
            echo "payload=${INPUT_PAYLOAD}" >> "$GITHUB_OUTPUT"
          fi

      - name: Chat通知 + 次アクション連鎖
        uses: ./.github/actions/notify-chat
        with:
          webhook_url: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
          status: ${{ steps.params.outputs.status }}
          title: ${{ steps.params.outputs.title }}
          message: ${{ steps.params.outputs.message }}
          next_event: ${{ steps.params.outputs.next_event }}
          payload: ${{ steps.params.outputs.payload }}
          github_token: ${{ secrets.PIPELINE_GITHUB_TOKEN }}
